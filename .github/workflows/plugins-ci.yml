# ==============================================================================
# EXAMPLE WORKFLOW FOR PLUGIN REPOSITORIES
# ==============================================================================
# This is a template workflow for repositories that contain Command Launcher plugins.
# Copy this file to YOUR plugin repository at: .github/workflows/plugins-ci.yml
#
# DO NOT use this in the cola-plugin-action repository itself!
# ==============================================================================

name: Plugin CI/CD Pipeline

on:
  push:
    # Validate on pushes to ANY branch
    # Only main/develop will create releases (controlled by job conditions)
    paths:
      - 'plugins/**'
      - '.github/workflows/plugins-ci.yml'
  pull_request:
    # Validate on ALL pull requests (regardless of target branch)
    paths:
      - 'plugins/**'
      - '.github/workflows/plugins-ci.yml'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  # ============================================================================
  # Validation Job - Runs on every push and PR
  # ============================================================================
  validate:
    name: Validate Plugin Manifests
    runs-on: ubuntu-latest
    outputs:
      validated-plugins: ${{ steps.validate.outputs.validated-plugins }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate manifests
        id: validate
        uses: mazurov/cola-plugin-action@main
        with:
          packages-directory: 'packages'
          validate-only: 'true'

      - name: Display validation results
        run: |
          echo "‚úÖ Validation completed successfully"
          echo "Validated plugins: ${{ steps.validate.outputs.validated-plugins }}"

  # ============================================================================
  # Test Package Job - Runs on PRs and branches
  # ============================================================================
  test-package:
    name: Test Package Generation
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request' || github.ref != 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Package plugins (ZIP)
        uses: mazurov/cola-plugin-action@main
        with:
          packages-directory: 'packages'
          package-format: 'zip'

      - name: List generated packages
        run: |
          echo "üì¶ Generated packages:"
          ls -lh build/packages/*.zip
          echo ""
          echo "üìù Checksums:"
          ls -lh build/packages/*.zip.sha256

      - name: Upload test packages as artifacts
        if: ${{ !env.ACT }}  # Skip when running with act locally
        uses: actions/upload-artifact@v4
        with:
          name: test-plugin-packages
          path: |
            build/packages/*.zip
            build/packages/*.zip.sha256
          retention-days: 7

  # ============================================================================
  # Release Job - Runs on main and develop branches only
  # Creates GitHub Release and publishes to OCI registry
  # ============================================================================
  release:
    name: Release Plugins
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    outputs:
      packaged-artifacts: ${{ steps.package.outputs.packaged-artifacts }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better release notes

      - name: Package and publish plugins
        id: package
        uses: mazurov/cola-plugin-action@main
        with:
          packages-directory: 'packages'
          package-format: 'both'  # Create ZIP archives AND push to OCI registry
          oci-registry: 'ghcr.io/${{ github.repository_owner }}'
          oci-username: ${{ github.actor }}
          oci-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release notes
        id: release-notes
        run: |
          cat << 'EOF' > release-notes.md
          # Command Launcher Plugins Release

          ## üì¶ Published Plugins

          This release includes the following plugins:

          EOF

          # Parse validated plugins JSON and add to release notes
          echo '${{ needs.validate.outputs.validated-plugins }}' | jq -r '.[]' | while read plugin; do
            echo "- **${plugin}**" >> release-notes.md
          done

          cat << 'EOF' >> release-notes.md

          ## üöÄ Installation

          ### Via ZIP (GitHub Releases)

          Download the plugin archive from the assets below and extract it to your Command Launcher plugins directory:

          ```bash
          # Download and extract
          unzip <plugin-name>-<version>.zip -d ~/.command-launcher/plugins/
          ```

          ### Via OCI Registry (Recommended)

          Pull plugins directly from the GitHub Container Registry:

          ```bash
          # Using ORAS
          oras pull ghcr.io/${{ github.repository_owner }}/<plugin-name>:<version>

          # Or using Command Launcher (if supported)
          cola plugin install ghcr.io/${{ github.repository_owner }}/<plugin-name>:<version>
          ```

          ## üîç Registry Information

          - **Registry:** ghcr.io/${{ github.repository_owner }}
          - **Tags:** Each plugin is tagged with its version and `latest`
          - **Authentication:** Use your GitHub token for private registries

          ---

          ü§ñ *Generated automatically by [Cola Plugin Action](https://github.com/criteo/cola-plugin-action)*
          EOF

      - name: Create GitHub Release
        if: ${{ !env.ACT }}  # Skip when running with act locally
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ github.run_number }}
          name: Plugin Release ${{ github.run_number }}
          body_path: release-notes.md
          files: |
            build/packages/*.zip
            build/packages/*.zip.sha256
          draft: false
          prerelease: false
          fail_on_unmatched_files: false  # Don't fail if some files are missing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  # Don't fail if release already exists

      - name: Check release status
        if: steps.package.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è  Release creation had issues, but this may be expected if versions already exist"
          echo "This is not necessarily an error - check the logs above for details"

      - name: Summary
        run: |
          echo "## ‚úÖ Release Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Published Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Packages:** ${{ steps.package.outputs.packaged-artifacts }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ OCI Registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`ghcr.io/${{ github.repository_owner }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull plugins with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "oras pull ghcr.io/${{ github.repository_owner }}/<plugin-name>:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Versions already in OCI registry or GitHub Releases are automatically skipped (not an error)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Cleanup Job - Clean up old artifacts and preview documentation
  # ============================================================================
  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    needs: [release]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Delete old workflow runs and artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const days = 30;
            const timestamp = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();

            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'plugins-ci.yml',
              status: 'success',
              created: `<${timestamp}`,
              per_page: 100
            });

            console.log(`Found ${runs.workflow_runs.length} old workflow runs`);

            for (const run of runs.workflow_runs) {
              console.log(`Deleting run ${run.id}`);
              await github.rest.actions.deleteWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });
            }
